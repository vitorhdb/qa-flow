name: QA FLOW! Quality Gate

on:
  pull_request:
    branches: [ main, master, develop ]
  push:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    name: Quality Gate Check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run QA FLOW! Analysis
        id: qa-analysis
        run: |
          # Aqui vocÃª executaria o QA FLOW! CLI ou API
          # Por enquanto, simula uma anÃ¡lise
          echo "Running QA FLOW! analysis..."
          
          # Exemplo de como seria a integraÃ§Ã£o:
          # npx qa-flow analyze --format json --output qa-results.json
          
          # Mock de resultado para demonstraÃ§Ã£o
          cat > qa-results.json << EOF
          {
            "passed": true,
            "scores": {
              "risk": 75,
              "security": 80,
              "quality": 70
            },
            "findings": {
              "critical": 0,
              "high": 2,
              "medium": 5,
              "low": 10
            }
          }
          EOF
      
      - name: Check Quality Gate
        id: quality-gate
        run: |
          # LÃª o resultado da anÃ¡lise
          RESULT=$(cat qa-results.json)
          PASSED=$(echo $RESULT | jq -r '.passed')
          RISK=$(echo $RESULT | jq -r '.scores.risk')
          SECURITY=$(echo $RESULT | jq -r '.scores.security')
          CRITICAL=$(echo $RESULT | jq -r '.findings.critical')
          HIGH=$(echo $RESULT | jq -r '.findings.high')
          
          echo "Quality Gate Results:"
          echo "  Risk Score: $RISK%"
          echo "  Security Score: $SECURITY%"
          echo "  Critical Findings: $CRITICAL"
          echo "  High Findings: $HIGH"
          
          # ConfiguraÃ§Ã£o do gate (pode ser ajustada)
          MIN_RISK=70
          MIN_SECURITY=70
          MAX_CRITICAL=0
          MAX_HIGH=5
          
          FAILED=false
          REASON=""
          
          if [ "$RISK" -lt "$MIN_RISK" ]; then
            FAILED=true
            REASON="Risk score too low: $RISK% (minimum: $MIN_RISK%)"
          fi
          
          if [ "$SECURITY" -lt "$MIN_SECURITY" ]; then
            FAILED=true
            REASON="Security score too low: $SECURITY% (minimum: $MIN_SECURITY%)"
          fi
          
          if [ "$CRITICAL" -gt "$MAX_CRITICAL" ]; then
            FAILED=true
            REASON="Critical findings found: $CRITICAL (maximum: $MAX_CRITICAL)"
          fi
          
          if [ "$HIGH" -gt "$MAX_HIGH" ]; then
            FAILED=true
            REASON="Too many high findings: $HIGH (maximum: $MAX_HIGH)"
          fi
          
          if [ "$FAILED" = true ]; then
            echo "::error::Quality Gate Failed: $REASON"
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "reason=$REASON" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "::notice::Quality Gate Passed âœ…"
            echo "passed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const result = JSON.parse(fs.readFileSync('qa-results.json', 'utf8'));
            
            const comment = `## ğŸ” QA FLOW! Quality Gate Results
            
            **Status:** ${result.passed ? 'âœ… PASSED' : 'âŒ FAILED'}
            
            ### Scores
            - **Risk:** ${result.scores.risk}%
            - **Security:** ${result.scores.security}%
            - **Quality:** ${result.scores.quality}%
            
            ### Findings
            - ğŸ”´ Critical: ${result.findings.critical}
            - ğŸŸ  High: ${result.findings.high}
            - ğŸŸ¡ Medium: ${result.findings.medium}
            - ğŸŸ¢ Low: ${result.findings.low}
            
            ${result.passed ? 'âœ… This PR meets the quality standards.' : 'âŒ This PR does not meet the quality standards. Please review the findings.'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Upload results artifact
        uses: actions/upload-artifact@v4
        with:
          name: qa-flow-results
          path: qa-results.json
          retention-days: 30
